<!DOCTYPE html>
<html>
<head>
<style>

body {
    background-color:black;
}

#ctx{
    border:4px solid #FFFFFF;
    border-radius:2px;
    display:block;
    margin-left:auto;
    margin-right:auto;
}

</style>
</head>

<div style = "width:100%;height:100%">
<canvas id="ctx" width = "1080" height = "1920"></canvas>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
	//Getting the socket and the document variables
    var socket = io();
    var ctx = document.getElementById("ctx").getContext("2d");
	var WIDTH = 1080;
    var HEIGHT = 1920;

    //Preparing all of the images and saving them in a list
    var Img = {};
    Img[0] = new Image()
    Img[0].src = '/client/img/Redblock.png';
    Img[1] = new Image()
    Img[1].src = '/client/img/Orangeblock.png';
    Img[2] = new Image()
    Img[2].src = '/client/img/Blueblock.png';
    Img[3] = new Image()
    Img[3].src = '/client/img/Greenblock.png';
    Img[4] = new Image()
    Img[4].src = '/client/img/Cyanblock.png';
    Img[5] = new Image()
    Img[5].src = '/client/img/Blueblock.png';
    Img[6] = new Image()
    Img[6].src = '/client/img/Purpleblock.png';    
    
	//The Block class, remembers position and color
	var Block = function(NColor, position){ 
		var self = {
			color:NColor,
			x: position.x,
			y: position.y,
            id: Math.random(),
		}
		self.draw = function(){
			//draw the block here
		    ctx.drawImage(Img[NColor], (self.x)*(WIDTH/12), HEIGHT - (self.y+1)*(WIDTH/12), (WIDTH/12), (WIDTH/12));
		}
        return self;
	
	}
    
    //Preparing a list of all blocks to keep track of.
	Block.list = {}
    
    
    //The Peice class, holds a list of all blocks.
	var Peice = function(data){
		var self = {
			blocks:data.blockList,
            color:data.color,
		
		}
		
        self.draw = function(dir){
            for(var i in self.blocks){
                self.blocks[i].draw();
            }
        }
        
		self.move = function(dir){
			for(var i in self.blocks){
                block = self.blocks[i]
               
				if(dir == 'left'){
                    block.x--;
                }
                else if(dir == 'right'){
                    block.x++;
                }
                else if(dir == 'down'){
                    block.y--;
                }
                else if(dir == 'up'){
                    block.y++;
                }
				
			}

		}
        return self;
	
	}
	
    //Preparing a 'peice' object to hold all the peice data.
    Peice.active = Peice({blockList:{}})
    
    //Creating an Update function that redraws everything with new data
    var Update = function(){
        ctx.fillStyle = 'black';
        ctx.fillRect(0,0,WIDTH,HEIGHT);
        for(var i in Block.list){
            Block.list[i].draw();
        }

        
        Peice.active.draw();

    }
    
    
	//Socket Functions

	//Updates the active peices position`
    socket.on('activeUpdate', function(data){
        if(data.dir == 'rotate'){
            color = Peice.active.color;
            newBlockList = {}
            var val;
            var count;
            for(var i = 0; i < data.active.length; i++){
                count = 0;
                val = data.active[i];
                
                while(val > 0){
                    console.log(count);
                    if((val & 1) != 0){
                        var newBlock = Block(color,{x:count, y:i});
                        newBlockList[newBlock.id] = newBlock;
                    }
                    val = val >> 1;
                    count++;
                }
            }
            Peice.active = Peice({color:color, blockList:newBlockList});
        
        }
        else{
            Peice.active.move(data.dir);
        }
        Update();
        
    });
    
	//deletes a saved row of blocks
	socket.on('deleteRow', function(data){
        
        for(var i in Block.list){
            var block = Block.list[i];
            if(block.y == data.row){
                delete Block.list[i];
            }
            else if(block.y > data.row){
                block.y--;
            }
        }
        
        for(var i in Peice.active.blocks){
            var block = Peice.active.blocks[i];
            
            if(block.y == data.row){
                delete Peice.active.blocks[i];
            }
            else if(block.y > data.row){
                block.y--;
            }
            
        }
        
        Update();
        
	});
    
	//Take the active block and makes it a normal one.
	socket.on('setActive', function(data){
        if(Peice.active){
            for(var i in Peice.active.blocks){
                var block = Peice.active.blocks[i];
                
                Block.list[block.id] = block;
            }
        }
        
        newBlockList = {}
        var val;
        var count;
        for(var i = 0; i < data.active.length; i++){
            count = 0;
            val = data.active[i];
                
            while(val > 0){
            
                if(val & 1 > 0){
                   var newBlock = Block(data.color,{x:count, y:i});
                   newBlockList[newBlock.id] = newBlock;
                }
                val = val >> 1;
                count++;
            }
        }
        Peice.active = Peice({color: data.color, blockList:newBlockList});
        Update()
	});
	
</script>
</html>